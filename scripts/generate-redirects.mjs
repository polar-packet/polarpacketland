#!/usr/bin/env node
import fs from 'fs/promises';
import path from 'path';
// simple slugify fallback (no external dep):
const slugify = (str) => String(str || '')
  .toLowerCase()
  .trim()
  .replace(/\\s+/g, '-')
  .replace(/[^a-z0-9\-\/]+/g, '')
  .replace(/--+/g, '-')
  .replace(/^[-\/]+|[-\/]+$/g, '');

const POSTS_DIR = path.resolve(process.cwd(), 'content/posts');
const OUT_FILE = path.resolve(process.cwd(), 'public/_redirects');

async function findFiles(dir) {
  const entries = await fs.readdir(dir, { withFileTypes: true });
  const files = [];
  for (const entry of entries) {
    const res = path.resolve(dir, entry.name);
    if (entry.isDirectory()) {
      const nested = await findFiles(res);
      files.push(...nested);
    } else if (entry.isFile() && /\.mdx?$|\.md$/.test(entry.name)) {
      files.push(res);
    }
  }
  return files;
}

async function extractSlug(filePath) {
  const content = await fs.readFile(filePath, 'utf8');
  const fm = content.match(/^---\s*\n([\s\S]*?)\n---/);
  if (fm) {
    const fmBody = fm[1];
    const m = fmBody.match(/^\s*slug:\s*['\"]?(.+?)['\"]?\s*$/m);
    if (m) return slugify(m[1]);
  }
  // fallback to filename without extension
  const name = path.basename(filePath, path.extname(filePath));
  return slugify(name);
}

(async function main() {
  try {
    // ensure output dir exists
    await fs.mkdir(path.dirname(OUT_FILE), { recursive: true });

    // gather post files
    let files = [];
    try {
      files = await findFiles(POSTS_DIR);
    } catch (e) {
      console.warn('No posts directory found; skipping redirect generation.');
      await fs.writeFile(OUT_FILE, '# _redirects generated: no posts found\n');
      return;
    }

    const redirects = new Map();

    for (const f of files) {
      const slug = await extractSlug(f);
      if (!slug) continue;
      const from = '/' + slug;
      const to = '/blog/' + slug;
      redirects.set(from, to);
    }

    const lines = [
      `# _redirects - generated by scripts/generate-redirects.mjs
# Maps old post root paths to /blog/<slug> to preserve SEO after permalink changes
# Run 'npm run generate:redirects' to regenerate
`,
    ];

    const sorted = Array.from(redirects.entries()).sort((a, b) => a[0].localeCompare(b[0]));
    for (const [from, to] of sorted) {
      lines.push(`${from} ${to} 301`);
    }

    const out = lines.join('\n') + '\n';
    await fs.writeFile(OUT_FILE, out, 'utf8');
    console.log(`Generated ${sorted.length} redirects to ${OUT_FILE}`);
  } catch (err) {
    console.error('Error generating redirects:', err);
    process.exitCode = 1;
  }
})();
